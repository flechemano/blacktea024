{"version":3,"file":"block-ref.js","sourceRoot":"","sources":["../src/block-ref.ts"],"names":[],"mappings":";;;;;;AAEA,+DAAkE;AAOlE,qCAAmC;AACnC,gDAAwB;AAExB,mDAAoE;AAEpE,yCAAmD;AAOnD,MAAM,GAAG,GAAG,IAAA,kCAAkB,EAAC,6BAAa,EAAE,WAAW,CAAC,CAAC;AAE3D,SAAgB,wBAAwB,CAAC,EACvC,QAAQ,EACR,YAAY,MACiB,EAAE;IAC/B,IAAI,CAAC,QAAQ,EAAE;QACb,MAAM,KAAK,CAAC,8DAA8D,CAAC,CAAC;KAC7E;IAED,IAAI,CAAC,YAAY,EAAE;QACjB,MAAM,KAAK,CACT,kEAAkE,CACnE,CAAC;KACH;IAED,OAAO,IAAA,uCAAqB,EAAC,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE;;QACpD,MAAM,aAAa,GAAG,IAAA,0BAAkB,EAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QAErD,2CAA2C;QAC3C,IAAI,aAAa,KAAK,SAAS,EAAE;YAC/B,OAAO,IAAI,EAAE,CAAC;SACf;QAED,MAAM,QAAQ,GAAG,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC;YACxC,CAAC,CAAC,MAAA,GAAG,CAAC,MAAM,CAAC,aAAa,CAAC,mCAAI,QAAQ;YACvC,CAAC,CAAC,QAAQ,CAAC;QAEb,uBAAuB;QACvB,IAAI,QAAQ,KAAK,QAAQ,EAAE;YACzB,GAAG,CAAC,oDAAoD,CAAC,CAAC;YAC1D,OAAO,IAAI,EAAE,CAAC;SACf;QAED,sBAAsB;QACtB,MAAM,iBAAiB,GAAG,MAAM,YAAY,CAAC,cAAc,EAAE,CAAC;QAC9D,GAAG,CACD,uCAAuC,aAAa,oBAAoB,iBAAiB,EAAE,CAC5F,CAAC;QAEF,+CAA+C;QAC/C,MAAM,YAAY,GAAG,IAAA,YAAK,EAAC,GAAG,CAAC,CAAC;QAEhC,IAAI,KAAK,CAAC,OAAO,CAAC,YAAY,CAAC,MAAM,CAAC,EAAE;YACtC,YAAY,CAAC,MAAM,CAAC,aAAa,CAAC,GAAG,iBAAiB,CAAC;SACxD;QAED,wBAAwB;QACxB,GAAG,CAAC,+BAA+B,EAAE,YAAY,CAAC,CAAC;QACnD,MAAM,QAAQ,GAAkC,MAAM,IAAA,cAAI,EACxD,QAAQ,CAAC,SAAS,CACnB,CAAC,IAAI,CAAC,QAAQ,EAAE,YAAY,CAAC,CAAC;QAC/B,6CAA6C;QAC7C,GAAG,CAAC,MAAM,GAAG,QAAQ,CAAC,MAAM,CAAC;QAC7B,GAAG,CAAC,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC;QAE3B,OAAO,SAAS,CAAC;IACnB,CAAC,CAAC,CAAC;AACL,CAAC;AAxDD,4DAwDC","sourcesContent":["import type { SafeEventEmitterProvider } from '@metamask/eth-json-rpc-provider';\nimport type { JsonRpcMiddleware } from '@metamask/json-rpc-engine';\nimport { createAsyncMiddleware } from '@metamask/json-rpc-engine';\nimport type {\n  Json,\n  JsonRpcParams,\n  PendingJsonRpcResponse,\n} from '@metamask/utils';\nimport type { PollingBlockTracker } from 'eth-block-tracker';\nimport { klona } from 'klona/full';\nimport pify from 'pify';\n\nimport { projectLogger, createModuleLogger } from './logging-utils';\nimport type { Block } from './types';\nimport { blockTagParamIndex } from './utils/cache';\n\ninterface BlockRefMiddlewareOptions {\n  blockTracker?: PollingBlockTracker;\n  provider?: SafeEventEmitterProvider;\n}\n\nconst log = createModuleLogger(projectLogger, 'block-ref');\n\nexport function createBlockRefMiddleware({\n  provider,\n  blockTracker,\n}: BlockRefMiddlewareOptions = {}): JsonRpcMiddleware<JsonRpcParams, Json> {\n  if (!provider) {\n    throw Error('BlockRefMiddleware - mandatory \"provider\" option is missing.');\n  }\n\n  if (!blockTracker) {\n    throw Error(\n      'BlockRefMiddleware - mandatory \"blockTracker\" option is missing.',\n    );\n  }\n\n  return createAsyncMiddleware(async (req, res, next) => {\n    const blockRefIndex = blockTagParamIndex(req.method);\n\n    // skip if method does not include blockRef\n    if (blockRefIndex === undefined) {\n      return next();\n    }\n\n    const blockRef = Array.isArray(req.params)\n      ? req.params[blockRefIndex] ?? 'latest'\n      : 'latest';\n\n    // skip if not \"latest\"\n    if (blockRef !== 'latest') {\n      log('blockRef is not \"latest\", carrying request forward');\n      return next();\n    }\n\n    // lookup latest block\n    const latestBlockNumber = await blockTracker.getLatestBlock();\n    log(\n      `blockRef is \"latest\", setting param ${blockRefIndex} to latest block ${latestBlockNumber}`,\n    );\n\n    // create child request with specific block-ref\n    const childRequest = klona(req);\n\n    if (Array.isArray(childRequest.params)) {\n      childRequest.params[blockRefIndex] = latestBlockNumber;\n    }\n\n    // perform child request\n    log('Performing another request %o', childRequest);\n    const childRes: PendingJsonRpcResponse<Block> = await pify(\n      provider.sendAsync,\n    ).call(provider, childRequest);\n    // copy child response onto original response\n    res.result = childRes.result;\n    res.error = childRes.error;\n\n    return undefined;\n  });\n}\n"]}